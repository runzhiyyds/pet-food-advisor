# 🧪 新功能测试指南 v2.0

## 🎯 测试前准备

1. **确保服务正在运行**
```bash
# 查看服务状态
curl http://localhost:8000/api/health

# 如果未运行，启动服务
bash start_local.sh
```

2. **打开浏览器**
   - 访问：http://localhost:8000
   - 打开开发者工具（F12）
   - 查看Console面板

3. **清除旧数据（可选，用于测试干净环境）**
```javascript
// 在浏览器Console中执行
localStorage.clear();
location.reload();
```

---

## ✅ 测试清单

### 测试1：步骤跳转优化 ⚡

**目标**：验证步骤1→步骤2的跳转速度提升

**步骤**：
1. 打开首页，填写宠物信息：
   - 选择物种：猫
   - 年龄：3岁
   - 体重：4.5kg
   - 健康状态：健康
   - 预算模式：中等

2. 点击"下一步：选择产品"

3. **观察**：
   - [ ] 是否立即看到骨架屏（灰色加载动画）
   - [ ] 骨架屏动画流畅
   - [ ] 产品列表在1-2秒内加载完成

4. **返回步骤1，再次点击"下一步"**

5. **观察（缓存测试）**：
   - [ ] 产品列表几乎瞬间加载（< 0.5秒）
   - [ ] 无明显等待时间
   - [ ] Console显示：`[CACHE] 命中缓存，产品数量: XX`

**验证缓存**：
```javascript
// 在Console中查看缓存
const cache = localStorage.getItem('pet_food_products_cache_cat');
console.log('缓存数据:', JSON.parse(cache));
```

**预期结果**：
- ✅ 首次加载：1-2秒，显示骨架屏
- ✅ 二次加载：<0.5秒，直接显示产品
- ✅ Console无错误

---

### 测试2：历史记录功能 📝

**目标**：验证历史记录的保存和查看

**步骤**：

#### 2.1 自动保存测试

1. 完成一次完整的分析流程：
   - 步骤1：填写宠物信息
   - 步骤2：选择3-5个产品
   - 步骤3：等待分析完成

2. 分析完成后，查看Console：
   - [ ] 显示：`[HISTORY] 分析结果已保存到历史记录: history_XXX`

3. 查看LocalStorage：
```javascript
// 在Console中执行
const history = localStorage.getItem('pet_food_analysis_history');
console.log('历史记录:', JSON.parse(history));
```

#### 2.2 查看历史记录

1. 点击页面右上角的 **"历史记录"** 按钮

2. **观察历史记录页面**：
   - [ ] 显示历史记录列表
   - [ ] 每条记录包含：
     - 🐱 物种图标
     - ⏰ 时间（如"刚刚"、"3分钟前"）
     - 📊 宠物信息（年龄、体重、健康状态）
     - 📦 产品数量
   - [ ] 三个操作按钮：查看、分享、删除

3. 点击 **"查看详情"**：
   - [ ] 正确显示完整的分析结果
   - [ ] AI分析内容完整
   - [ ] 推荐产品列表正确

#### 2.3 删除历史记录

1. 回到历史记录页面
2. 点击某条记录的 **删除按钮（🗑️）**
3. 确认删除
4. **观察**：
   - [ ] 该记录从列表中消失
   - [ ] 显示"删除成功"提示

#### 2.4 清空所有历史

1. 点击 **"清空全部"** 按钮
2. 确认清空
3. **观察**：
   - [ ] 所有记录被清除
   - [ ] 显示"暂无历史记录"页面
   - [ ] 有"返回首页"按钮

#### 2.5 容量限制测试（可选）

1. 连续进行21次分析（超过20条限制）
2. 查看历史记录：
   - [ ] 只保留最新的20条
   - [ ] 最早的1条被自动删除

---

### 测试3：分享功能 🔗

**目标**：验证分享链接的生成和访问

**步骤**：

#### 3.1 从结果页分享

1. 完成一次分析
2. 在结果页点击 **"分享结果"** 按钮
3. **观察分享弹窗**：
   - [ ] 弹窗正确显示
   - [ ] 显示完整的分享链接
   - [ ] 链接格式：`http://localhost:8000/?share=XXX`
   - [ ] 有"复制"按钮
   - [ ] 有社交平台选项（微信、QQ、二维码）

4. 点击 **"复制"** 按钮：
   - [ ] 显示"链接已复制到剪贴板！"提示
   - [ ] 可以粘贴（Ctrl+V测试）

5. 点击背景或关闭按钮：
   - [ ] 弹窗正确关闭

#### 3.2 从历史记录分享

1. 进入历史记录页面
2. 点击某条记录的 **"分享"** 按钮
3. **观察**：
   - [ ] 分享弹窗正确显示
   - [ ] 链接可复制

#### 3.3 访问分享链接

1. 复制分享链接
2. **在新的隐私窗口中打开链接**
   - Chrome: Ctrl+Shift+N
   - Safari: Cmd+Shift+N

3. **观察分享页面**：
   - [ ] 页面正确加载
   - [ ] 显示"朋友分享的分析结果"标识
   - [ ] 宠物信息正确显示：
     - 物种、年龄、体重、健康状态
   - [ ] AI分析内容显示
   - [ ] 推荐产品列表显示（Top 5）
   - [ ] 产品信息正确：名称、品牌、价格、评分

4. 点击 **"开始我的分析"** 按钮：
   - [ ] 跳转到首页

#### 3.4 分享链接验证

```javascript
// 在Console中测试分享链接生成
const testData = {
    pet_info: { species: 'cat', age_months: 36, weight_kg: 4.5 },
    analysis_result: {
        recommended_products: [
            { product_name: '测试产品', brand: '测试品牌', price: 100, score: 95 }
        ],
        ai_analysis: '这是测试分析'
    }
};

const shareLink = window.ShareManager.generateShareLink(testData);
console.log('分享链接:', shareLink);

// 复制链接到新标签页测试
```

---

### 测试4：兼容性测试 🌐

**目标**：验证在不同浏览器和设备上的表现

#### 4.1 桌面浏览器

- [ ] **Chrome/Edge**
  - 所有功能正常
  - 骨架屏流畅
  - 历史记录正常
  - 分享功能正常

- [ ] **Safari**
  - 所有功能正常
  - LocalStorage可能有警告（正常）
  - 功能降级处理生效

- [ ] **Firefox**
  - 所有功能正常

#### 4.2 移动端（可选）

- [ ] 响应式布局正常
- [ ] 历史记录按钮正确显示（只显示图标）
- [ ] 分享弹窗适配移动端

---

### 测试5：错误处理 ⚠️

**目标**：验证异常情况的处理

#### 5.1 LocalStorage被禁用

1. 在浏览器中禁用LocalStorage（Safari隐私模式）
2. **观察**：
   - [ ] 功能仍然可用（降级到SessionStorage或内存）
   - [ ] 可能显示警告信息
   - [ ] 分析功能不受影响

#### 5.2 缓存过期

```javascript
// 手动设置过期缓存
const expiredCache = {
    timestamp: Date.now() - (25 * 60 * 60 * 1000), // 25小时前
    species: 'cat',
    products: []
};
localStorage.setItem('pet_food_products_cache_cat', JSON.stringify(expiredCache));
```

重新加载步骤2：
- [ ] 自动清除过期缓存
- [ ] 重新从API加载产品
- [ ] Console显示：`[CACHE] 缓存已过期，已清除`

#### 5.3 分享链接解析失败

访问无效分享链接：`http://localhost:8000/?share=invalid`
- [ ] 显示错误提示："无效的分享链接"
- [ ] 可以正常返回首页

---

## 📊 性能测试

### 测试工具

**Chrome DevTools**:
1. 打开开发者工具（F12）
2. 切换到 "Network" 面板
3. 勾选 "Disable cache"（测试首次加载）
4. 取消勾选（测试缓存）

### 性能指标

| 操作 | 目标时间 | 实际时间 | 结果 |
|------|----------|----------|------|
| 步骤1→2（首次） | <2秒 | _____ | ⭕ |
| 步骤1→2（缓存） | <0.5秒 | _____ | ⭕ |
| 历史记录加载 | <0.3秒 | _____ | ⭕ |
| 分享链接生成 | <0.1秒 | _____ | ⭕ |
| 分享页面加载 | <1秒 | _____ | ⭕ |

---

## 🐛 常见问题排查

### 问题1：缓存未生效

**症状**：每次都从API加载，Console无缓存日志

**排查**：
1. 检查LocalStorage是否可用
2. 查看Console是否有报错
3. 清除缓存重试：`localStorage.clear()`

### 问题2：历史记录不显示

**症状**：点击历史记录按钮，显示"暂无历史记录"

**排查**：
1. 检查是否完成过分析
2. 查看LocalStorage：
```javascript
localStorage.getItem('pet_food_analysis_history')
```
3. 检查Console是否有保存失败的日志

### 问题3：分享链接打不开

**症状**：访问分享链接显示错误

**排查**：
1. 检查链接是否完整
2. 查看Console错误信息
3. 测试链接解析：
```javascript
const shareCode = '从URL中提取的share参数';
const data = window.ShareManager.parseShareLink(shareCode);
console.log(data);
```

### 问题4：骨架屏不显示

**症状**：步骤2直接显示空白，然后显示产品

**排查**：
1. 检查products.js是否正确加载
2. 查看Console错误
3. 清除缓存重试

---

## ✅ 测试完成确认

完成以上测试后，请确认：

- [ ] 步骤跳转速度明显提升
- [ ] 历史记录功能完整可用
- [ ] 分享功能正常工作
- [ ] 无JavaScript错误
- [ ] 所有提示信息正确
- [ ] 移动端适配正常
- [ ] 缓存机制生效

---

## 📝 测试报告模板

```
测试时间：____年__月__日
测试环境：
- 浏览器：________
- 操作系统：________
- 屏幕分辨率：________

测试结果：
1. 步骤跳转优化：✅/❌
   - 首次加载时间：____秒
   - 缓存加载时间：____秒
   
2. 历史记录功能：✅/❌
   - 自动保存：✅/❌
   - 查看详情：✅/❌
   - 删除功能：✅/❌
   
3. 分享功能：✅/❌
   - 链接生成：✅/❌
   - 复制功能：✅/❌
   - 链接访问：✅/❌

发现的问题：
1. ________
2. ________

建议改进：
1. ________
2. ________

总体评价：________
```

---

**测试愉快！** 🎉

如有问题，请查看：
- `功能优化更新说明.md` - 完整功能文档
- `本地调试指南.md` - 调试技巧
- Console日志 - 详细错误信息
