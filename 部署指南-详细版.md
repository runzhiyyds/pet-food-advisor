# 🚀 宠物口粮智能助手 - 详细部署指南（新手友好版）

## 📋 部署前准备

### 第一步：检查本地环境

1. **确保本地能正常运行**
   ```bash
   # 在项目目录下运行
   python3 main_sqlite.py
   # 或者
   uvicorn main_sqlite:app --host 0.0.0.0 --port 8000
   ```
   
2. **测试完整流程**
   - 填写宠物信息
   - 选择产品
   - 开始分析
   - 查看结果
   
   确保所有功能都正常！

### 第二步：准备 GitHub 账号

1. 如果没有 GitHub 账号，访问 https://github.com 注册
2. 记住你的用户名（例如：`yourusername`）

---

## 🎯 部署步骤（按顺序执行）

### 步骤 1：创建 GitHub 仓库并上传代码

#### 1.1 在 GitHub 创建新仓库

1. 登录 GitHub
2. 点击右上角 **+** 号 → **New repository**
3. 填写信息：
   - **Repository name**: `pet-food-advisor`（或你喜欢的名字）
   - **Description**: `宠物口粮智能决策助手`
   - **Visibility**: 选择 **Public**（GitHub Pages 免费版需要公开仓库）
   - **不要**勾选 "Initialize this repository with a README"
4. 点击 **Create repository**

#### 1.2 在本地初始化 Git 并上传代码

打开终端，进入项目目录：

```bash
# 进入项目目录
cd "/Users/guochenyuan/Desktop/宠物粮选择"

# 初始化 Git（如果还没有）
git init

# 创建 .gitignore 文件（如果还没有）
cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
.venv

# 数据库
*.db
*.sqlite
*.sqlite3
pet_food_selection.db

# IDE
.vscode/
.idea/
*.swp
*.swo

# 系统文件
.DS_Store
Thumbs.db

# 日志
*.log

# 环境变量
.env
.env.local
EOF

# 添加所有文件
git add .

# 提交代码
git commit -m "Initial commit: 宠物口粮智能助手完整版本"

# 添加远程仓库（替换 YOUR_USERNAME 为你的 GitHub 用户名）
git remote add origin https://github.com/YOUR_USERNAME/pet-food-advisor.git

# 推送到 GitHub
git branch -M main
git push -u origin main
```

**注意**：如果提示需要登录，GitHub 现在要求使用 Personal Access Token 而不是密码。

**如何获取 Personal Access Token**：
1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. 点击 "Generate new token (classic)"
3. 勾选 `repo` 权限
4. 生成后复制 token，在输入密码时使用这个 token

---

### 步骤 2：部署后端到 Render

#### 2.1 注册 Render 账号

1. 访问 https://render.com
2. 点击 **Get Started for Free**
3. 选择 **Sign up with GitHub**（推荐，方便连接仓库）
4. 授权 Render 访问你的 GitHub 账号

#### 2.2 创建 Web Service

1. 登录 Render Dashboard
2. 点击 **New +** → **Web Service**
3. 选择 **Connect account**（如果还没连接 GitHub）
4. 在仓库列表中找到 `pet-food-advisor`，点击 **Connect**

#### 2.3 配置服务

填写以下信息：

- **Name**: `pet-food-advisor-api`（或你喜欢的名字）
- **Environment**: 选择 **Python 3**
- **Region**: 选择离你最近的区域（例如：Singapore）
- **Branch**: `main`
- **Root Directory**: 留空（使用根目录）
- **Build Command**: 
  ```bash
  pip install -r requirements.txt
  ```
- **Start Command**: 
  ```bash
  uvicorn main_sqlite:app --host 0.0.0.0 --port $PORT
  ```
- **Plan**: 选择 **Free**（免费计划）

#### 2.4 配置环境变量（可选）

在 **Environment Variables** 部分，可以添加：

- `PYTHON_VERSION`: `3.11`（可选，确保 Python 版本）

**注意**：`PORT` 变量 Render 会自动设置，不需要手动添加。

#### 2.5 创建服务

1. 点击 **Create Web Service**
2. 等待部署完成（大约 5-10 分钟）
3. 部署成功后，你会看到服务 URL，例如：
   ```
   https://pet-food-advisor-api.onrender.com
   ```
4. **重要**：复制这个 URL，稍后会用到！

#### 2.6 测试后端

1. 在浏览器访问：`https://你的服务名.onrender.com/docs`
2. 应该能看到 FastAPI 的文档页面
3. 如果看到文档页面，说明后端部署成功！

---

### 步骤 3：配置前端 API 地址

#### 3.1 修改前端代码

编辑 `static/index.html`，在 `<head>` 标签内（大约第 10 行）添加：

```html
<script>
  // 设置后端 API 地址（替换为你的 Render 服务地址）
  window.API_BASE_URL = 'https://pet-food-advisor-api.onrender.com';
</script>
```

**重要**：将 `pet-food-advisor-api.onrender.com` 替换为你实际的 Render 服务地址！

#### 3.2 提交更改

```bash
# 添加修改
git add static/index.html

# 提交
git commit -m "配置生产环境 API 地址"

# 推送到 GitHub
git push
```

---

### 步骤 4：部署前端到 GitHub Pages

#### 4.1 启用 GitHub Pages

1. 在 GitHub 仓库页面，点击 **Settings**
2. 在左侧菜单找到 **Pages**
3. 在 **Source** 部分：
   - 选择 **Deploy from a branch**
   - Branch 选择 **main**
   - Folder 选择 **/static**
4. 点击 **Save**

#### 4.2 等待部署

1. 等待几分钟（通常 1-3 分钟）
2. 刷新页面，你会看到 GitHub Pages 的 URL：
   ```
   https://YOUR_USERNAME.github.io/pet-food-advisor/
   ```
3. **重要**：复制这个 URL！

#### 4.3 测试前端

1. 访问你的 GitHub Pages URL
2. 打开浏览器开发者工具（F12）→ Console
3. 检查是否有错误
4. 尝试填写宠物信息，看是否能正常提交

---

### 步骤 5：验证完整流程

#### 5.1 测试清单

在 GitHub Pages 上测试以下功能：

- [ ] ✅ 页面能正常加载
- [ ] ✅ 填写宠物信息能正常提交
- [ ] ✅ 产品选择页面能正常显示
- [ ] ✅ 系统推荐功能正常
- [ ] ✅ 手动输入产品功能正常
- [ ] ✅ 开始分析功能正常
- [ ] ✅ 进度条能正常显示
- [ ] ✅ 分析结果能正常显示
- [ ] ✅ 匿名化显示正常
- [ ] ✅ Tab 切换正常
- [ ] ✅ 导出图片功能正常

#### 5.2 常见问题排查

**问题 1：CORS 错误**

如果浏览器控制台出现 CORS 错误：
1. 检查后端是否正常运行（访问 `/docs` 页面）
2. 检查 `main_sqlite.py` 中 CORS 配置是否正确
3. 确保 `allow_origins=["*"]` 已设置

**问题 2：404 错误**

如果 API 请求返回 404：
1. 检查前端 `window.API_BASE_URL` 是否正确
2. 检查后端 URL 是否包含 `/api` 路径
3. 检查后端路由是否正确

**问题 3：后端休眠**

Render 免费计划在 15 分钟无活动后会休眠：
- 首次访问需要等待约 30 秒唤醒
- 这是正常的，不是错误

**解决方案**：
- 使用 UptimeRobot（免费）定期 ping 后端
- 或升级到付费计划（$7/月）

---

### 步骤 6：配置自定义域名（可选）

#### 6.1 前端域名（GitHub Pages）

1. 在 GitHub 仓库 Settings → Pages
2. 在 **Custom domain** 输入你的域名（例如：`petfood.yourdomain.com`）
3. 保存后，GitHub 会显示需要配置的 DNS 记录
4. 在你的域名 DNS 设置中添加 CNAME 记录：
   ```
   类型: CNAME
   名称: petfood（或你想要的子域名）
   值: YOUR_USERNAME.github.io
   ```

#### 6.2 后端域名（Render）

1. 在 Render Dashboard → 你的服务 → Settings
2. 找到 **Custom Domains**
3. 添加你的子域名（例如：`api.yourdomain.com`）
4. Render 会显示需要配置的 DNS 记录
5. 在你的域名 DNS 设置中添加 CNAME 记录：
   ```
   类型: CNAME
   名称: api（或你想要的子域名）
   值: Render 提供的地址
   ```

**注意**：DNS 配置可能需要几小时到 48 小时生效。

---

## 🔄 更新部署

### 更新代码

当你修改代码后：

```bash
# 1. 添加修改的文件
git add .

# 2. 提交更改
git commit -m "描述你的更改"

# 3. 推送到 GitHub
git push
```

### 自动部署

- **前端**：GitHub Pages 会自动更新（1-3 分钟）
- **后端**：Render 会自动检测并重新部署（5-10 分钟）

### 查看部署状态

- **前端**：GitHub 仓库 → Actions 标签页
- **后端**：Render Dashboard → 你的服务 → Logs

---

## 📊 监控和维护

### 查看日志

**前端日志**：
- 浏览器开发者工具 → Console
- GitHub Actions → 部署日志

**后端日志**：
- Render Dashboard → 你的服务 → Logs
- 可以实时查看错误和调试信息

### 性能监控

**免费工具**：
- Google Analytics（前端访问统计）
- Render Dashboard（后端性能）

---

## ✅ 部署完成检查清单

- [ ] GitHub 仓库已创建并推送代码
- [ ] Render 后端服务已创建并部署成功
- [ ] 前端 API 地址已配置正确
- [ ] GitHub Pages 已启用并可以访问
- [ ] 完整流程测试通过
- [ ] 没有 CORS 错误
- [ ] 没有 404 错误
- [ ] 分析功能正常工作
- [ ] 结果页面正常显示

---

## 🎉 完成！

恭喜！你的应用已经成功部署！

**访问地址**：
- 前端：`https://YOUR_USERNAME.github.io/pet-food-advisor/`
- 后端：`https://pet-food-advisor-api.onrender.com`
- API 文档：`https://pet-food-advisor-api.onrender.com/docs`

**下一步**：
1. 分享给你的朋友测试
2. 收集反馈并优化
3. 考虑添加更多功能

---

## 🆘 需要帮助？

如果遇到问题：
1. 检查本文档的"常见问题排查"部分
2. 查看 GitHub Actions 和 Render Logs
3. 检查浏览器控制台的错误信息

祝你部署顺利！🎊

