# 🚀 本地调试指南

## 1️⃣ 快速启动（推荐）

```bash
# 方法1：一键启动（最简单）
bash start_local.sh

# 方法2：加载环境变量后启动
source .env.local
python3 main_sqlite.py
```

启动后访问：
- **前端页面**: http://localhost:8000
- **API文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/api/health

---

## 2️⃣ 调试清单

### ✅ 启动前检查

```bash
# 1. 检查Python版本（需要3.8+）
python3 --version

# 2. 安装依赖
pip3 install -r requirements.txt

# 3. 检查数据库文件是否存在
ls -lh pet_food_selection.db

# 4. 验证数据库内容
python3 verify_database.py
```

### ✅ 功能测试流程

#### 测试1：前端加载
1. 打开 http://localhost:8000
2. 检查页面是否正常显示
3. 打开浏览器控制台，查看是否有报错

#### 测试2：宠物信息填写
- [x] 选择宠物类型（猫/狗）
- [x] 填写年龄、体重
- [x] 选择健康状态
- [x] 选择口味偏好
- [x] 点击"获取推荐"

#### 测试3：推荐结果
- [x] 查看是否返回推荐产品
- [x] 检查产品图片、价格显示
- [x] 验证AI分析结果
- [x] 测试产品详情弹窗

#### 测试4：API直接测试
```bash
# 测试健康检查
curl http://localhost:8000/api/health

# 测试推荐接口
curl -X POST http://localhost:8000/api/recommend \
  -H "Content-Type: application/json" \
  -d '{
    "species": "cat",
    "age": 3,
    "weight": 4.5,
    "health_issues": ["normal"],
    "taste_preference": ["fish"]
  }'
```

---

## 3️⃣ 常见问题排查

### ❌ 端口被占用
```bash
# 查看占用8000端口的进程
lsof -ti:8000

# 杀死进程
lsof -ti:8000 | xargs kill -9
```

### ❌ 数据库错误
```bash
# 重新初始化数据库
rm pet_food_selection.db
python3 sqlite_db_utils.py
```

### ❌ Dify API调用失败
检查日志中是否有：
- `Connection timeout` - 网络问题
- `401 Unauthorized` - API密钥错误
- `429 Too Many Requests` - 请求频率过高

**解决方案**：
1. 检查网络连接
2. 验证 `.env.local` 中的 `DIFY_API_KEY`
3. 查看 `server.log` 详细日志

### ❌ 前端请求失败
打开浏览器控制台，查看：
1. Network面板 - 查看API请求状态
2. Console面板 - 查看JavaScript错误
3. 检查 `static/app_fixed.js` 中的 `API_BASE` 配置

---

## 4️⃣ 实时日志监控

```bash
# 监控服务器日志
tail -f server.log

# 过滤特定内容
tail -f server.log | grep "ERROR"
tail -f server.log | grep "Dify"
```

---

## 5️⃣ 性能测试

### 单次请求测试
```bash
time curl -X POST http://localhost:8000/api/recommend \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### 并发测试（可选）
```bash
# 使用ab工具
ab -n 10 -c 2 http://localhost:8000/api/health
```

---

## 6️⃣ 数据验证

```bash
# 查看数据库产品数量
sqlite3 pet_food_selection.db "SELECT species, COUNT(*) FROM products GROUP BY species;"

# 查看产品详情（前10个）
sqlite3 pet_food_selection.db "SELECT name, brand, price FROM products LIMIT 10;"

# 检查数据质量
python3 check_data_quality.py
```

---

## 7️⃣ 准备发布

### ✅ 发布前检查清单

- [ ] 所有功能测试通过
- [ ] 无报错和警告日志
- [ ] 数据库数据完整
- [ ] API响应速度正常（<3秒）
- [ ] 前端显示无异常
- [ ] 浏览器控制台无错误

### 🚀 发布步骤

```bash
# 1. 提交本地修改
git add -A
git status
git commit -m "本地调试完成，准备发布"

# 2. 推送到GitHub（触发Render自动部署）
git push origin main

# 3. 查看Render部署状态
# 访问: https://dashboard.render.com
# 检查构建日志
```

### 📦 Render环境变量配置

登录Render后台，设置以下环境变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `DIFY_API_KEY` | `app-H3Owfh8VRao6bUv6wFgRt7Kg` | Dify API密钥 |
| `ENVIRONMENT` | `production` | 生产环境标识 |
| `LOG_LEVEL` | `INFO` | 生产环境日志级别 |

---

## 8️⃣ 回滚方案

如果发布后出现问题：

```bash
# 1. 本地回滚到上一个版本
git log --oneline -5
git reset --hard <commit_hash>

# 2. 强制推送
git push origin main --force

# 3. 或者在Render后台手动回滚部署
```

---

## 📞 紧急联系

如遇到无法解决的问题：
1. 查看 `BUG_FIX_REPORT.md`
2. 检查 `server.log` 完整日志
3. 在GitHub仓库提Issue

---

**祝调试顺利！🎉**
