# 测试新功能指南 v2.1

## 🔧 前置准备

1. **确保服务正在运行**
```bash
# 检查服务状态
curl http://localhost:8000/api/health

# 如果没有运行，启动服务
bash start_local.sh
```

2. **打开浏览器开发者工具**
- Chrome/Edge: `F12` 或 `Cmd+Option+I` (Mac)
- 切换到 Console 标签页
- 观察日志输出

---

## 🧪 测试1：验证 Dify 调用

### 步骤：
1. 访问 http://localhost:8000
2. 填写宠物信息（猫/狗，年龄，体重等）
3. 点击"下一步：选择产品"
4. 选择 3-5 个产品
5. **确保开关是"🤖 真实AI"模式**（蓝色）
6. 点击"开始智能分析"

### 预期结果：
**浏览器控制台：**
```
[DEBUG] 分析模式: Dify AI
[DEBUG] 分析请求: {use_dify: true, ...}
```

**服务器日志：**
```bash
# 在另一个终端查看实时日志
tail -f server.log
```

应该看到：
```
[DIFY] 开始使用Dify分析，产品数量: 3
[DIFY] 会话ID: session_xxx, 总产品数: 3
[DIFY] 后台线程启动，开始调用DifyAnalysisEngine
[DIFY] 调用analyze_products_with_progress, user_id=xxx
```

### 如果看到 `[FALLBACK]`：
说明 Dify 没有被调用，可能原因：
1. ❌ 环境变量 `DIFY_API_KEY` 未设置
2. ❌ 前端传递的 `use_dify` 为 false
3. ❌ 后端 Dify 初始化失败

**解决方法：**
```bash
# 检查环境变量
echo $DIFY_API_KEY

# 如果没有，设置它
export DIFY_API_KEY=app-H3Owfh8VRao6bUv6wFgRt7Kg

# 重启服务
lsof -ti:8000 | xargs kill -9
bash start_local.sh
```

---

## 🧪 测试2：历史记录功能

### 步骤：
1. 完成一次完整的分析（等待结果显示）
2. 观察浏览器控制台，应该看到：
   ```
   [HISTORY] 分析结果已保存到历史记录: history_xxx
   ```
3. 点击右上角"历史记录"按钮
4. 确认能看到刚才的分析记录

### 预期结果：
- ✅ 显示历史记录列表
- ✅ 包含时间、宠物信息、产品数量
- ✅ 可以点击"查看详情"重新查看
- ✅ 可以点击"分享"按钮
- ✅ 可以删除单条记录

### 如果没有显示历史记录：
**打开浏览器控制台，输入：**
```javascript
// 检查是否有 HistoryManager
console.log(window.HistoryManager);

// 手动获取历史记录
const history = localStorage.getItem('pet_food_analysis_history');
console.log(JSON.parse(history));
```

如果返回 `null` 或 `undefined`，说明：
1. ❌ 历史记录没有保存成功
2. ❌ LocalStorage 被禁用
3. ❌ 存储空间不足

---

## 🧪 测试3：分享功能

### 步骤：
1. 在结果页面，点击"分享结果"按钮
2. 应该弹出分享弹窗
3. 点击"复制链接"
4. 打开新标签页，粘贴链接访问

### 预期结果：
**分享链接格式：**
```
http://localhost:8000/?share=eyJwIjp7InMiOiJjYXQi...
```

**打开链接后：**
- ✅ 显示分享的宠物信息
- ✅ 显示 AI 分析结果
- ✅ 显示 Top 推荐产品
- ✅ 底部显示"分享来自 xx"

### 如果分享按钮不见了：
**浏览器控制台输入：**
```javascript
// 检查 ShareManager 是否存在
console.log(window.ShareManager);

// 手动生成分享链接
if (window.ShareManager && window.appState) {
    const shareLink = window.ShareManager.generateShareLink({
        pet_info: window.appState.petInfo,
        selected_products: window.appState.selectedProducts,
        custom_products: window.appState.customProducts,
        analysis_result: window.appState.analysisResult
    });
    console.log('分享链接:', shareLink);
}
```

---

## 🧪 测试4：产品加载性能

### 步骤：
1. 清空浏览器缓存（可选）
2. 填写宠物信息
3. 点击"下一步：选择产品"
4. **观察加载时间**

### 预期结果：
**首次加载：**
- ⚡ 立即显示骨架屏（灰色加载动画）
- 📡 1-2秒后显示实际产品

**第二次加载：**
- ⚡ **瞬间**显示产品（<0.5秒）
- 📦 从缓存加载

**浏览器控制台：**
```
[CACHE] 命中缓存，产品数量: 100
```

或

```
[API] 从服务器加载产品...
[CACHE] 产品已缓存，数量: 100
```

---

## 📝 问题排查清单

### 如果 Dify 不工作：
- [ ] 检查 `DIFY_API_KEY` 是否设置
- [ ] 查看 `server.log` 中的错误信息
- [ ] 确认开关在"真实AI"位置
- [ ] 检查网络连接

### 如果历史记录不显示：
- [ ] 检查浏览器控制台是否有错误
- [ ] 测试 `window.HistoryManager` 是否存在
- [ ] 检查 LocalStorage 是否可用
- [ ] 查看是否有隐私模式限制

### 如果分享功能异常：
- [ ] 检查 `window.ShareManager` 是否存在
- [ ] 测试分享链接生成函数
- [ ] 检查 URL 参数是否正确编码
- [ ] 确认分享页面能正确解析数据

---

## 🎯 快速验证命令

```bash
# 1. 检查服务状态
curl http://localhost:8000/api/health

# 2. 测试产品API
curl 'http://localhost:8000/api/products?species=cat&limit=3' | jq

# 3. 查看实时日志
tail -f server.log | grep -E "\[DIFY\]|\[HISTORY\]|\[CACHE\]"

# 4. 重启服务
lsof -ti:8000 | xargs kill -9 && bash start_local.sh
```

---

## ✅ 成功标准

所有功能正常时，你应该能：
1. ✅ 看到 Dify 真实分析（1-2分钟等待）
2. ✅ 查看历史记录列表
3. ✅ 复制并打开分享链接
4. ✅ 感受到产品加载的性能提升

如果有任何问题，请检查浏览器控制台和 `server.log` 文件！
