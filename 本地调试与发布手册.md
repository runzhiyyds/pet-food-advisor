# 📘 本地调试与发布完整手册

## 🎯 快速导航

| 阶段 | 操作 | 命令 |
|------|------|------|
| 🚀 启动服务 | 本地启动 | `bash start_local.sh` |
| 🧪 快速测试 | 自动测试 | `bash 快速测试.sh` |
| 🌐 浏览器访问 | 打开页面 | http://localhost:8000 |
| 📋 查看日志 | 实时监控 | `tail -f server.log` |
| 🚢 发布上线 | 自动发布 | `bash 发布到Render.sh` |

---

## 📖 详细操作指南

### 一、本地启动与调试

#### 1. 启动本地服务

```bash
# 方法1：一键启动（推荐）
bash start_local.sh

# 方法2：手动启动
source .env.local  # 加载环境变量
python3 main_sqlite.py

# 方法3：使用uvicorn（开发模式，支持热重载）
export DIFY_API_KEY=app-H3Owfh8VRao6bUv6wFgRt7Kg
uvicorn main_sqlite:app --host 0.0.0.0 --port 8000 --reload
```

**启动成功标志**：
```
✅ SQLite数据库连接成功
✅ 数据库初始化成功
✅ Dify客户端加载成功
🎉 应用启动完成！
```

访问地址：
- 🌐 前端页面: http://localhost:8000
- 📚 API文档: http://localhost:8000/docs
- ❤️ 健康检查: http://localhost:8000/api/health

#### 2. 停止服务

```bash
# 方法1：在终端按 Ctrl+C

# 方法2：杀死进程
lsof -ti:8000 | xargs kill -9
```

---

### 二、功能测试

#### 快速自动测试

```bash
bash 快速测试.sh
```

测试内容：
- ✅ 服务健康检查
- ✅ 产品列表API
- ✅ 创建宠物信息
- ✅ 分析API调用

#### 手动前端测试流程

**测试1：宠物信息填写**
1. 打开 http://localhost:8000
2. 选择宠物类型（猫/狗）
3. 填写年龄（月龄）和体重（公斤）
4. 选择健康状态
5. 选择预算模式
6. 点击"下一步"

**验证点**：
- [ ] 表单验证生效（必填项检查）
- [ ] 页面无报错
- [ ] 成功跳转到步骤2

**测试2：产品选择**
1. 查看产品列表是否正常加载
2. 测试搜索功能（输入品牌或产品名）
3. 测试筛选功能（价格、类型）
4. 选择3-5个产品
5. 尝试手动添加自定义产品
6. 点击"开始分析"

**验证点**：
- [ ] 产品图片正常显示
- [ ] 产品价格、重量信息正确
- [ ] 可以正常选择/取消产品
- [ ] 手动添加产品功能正常
- [ ] 成功跳转到步骤3

**测试3：查看分析结果**
1. 观察分析进度条
2. 等待AI分析完成（约10-30秒）
3. 查看推荐产品列表
4. 阅读AI分析理由
5. 点击产品查看详情

**验证点**：
- [ ] 进度条正常显示
- [ ] AI分析结果合理
- [ ] 推荐产品与宠物信息匹配
- [ ] 产品详情弹窗正常
- [ ] 无JavaScript错误

#### API直接测试

```bash
# 1. 健康检查
curl http://localhost:8000/api/health
# 预期：{"status":"ok","message":"宠物口粮智能决策助手运行正常","database":"SQLite"}

# 2. 获取产品列表
curl 'http://localhost:8000/api/products?species=cat&limit=5'
# 预期：{"success":true,"products":[...]}

# 3. 创建宠物信息
curl -X POST http://localhost:8000/api/pet/create \
  -H "Content-Type: application/json" \
  -d '{
    "species": "cat",
    "age_months": 36,
    "weight_kg": 4.5,
    "health_status": "健康",
    "budget_mode": "medium"
  }'
# 预期：{"success":true,"pet_id":1}

# 4. 启动简单分析（不使用Dify，避免消耗配额）
curl -X POST http://localhost:8000/api/analysis/simple \
  -H "Content-Type: application/json" \
  -d '{
    "pet": {
      "species": "cat",
      "age_months": 36,
      "weight_kg": 4.5,
      "health_status": "健康"
    },
    "product_ids": [],
    "use_dify": false
  }'
# 预期：{"success":true,"session_id":"..."}
```

---

### 三、调试技巧

#### 1. 查看实时日志

```bash
# 实时查看所有日志
tail -f server.log

# 只看错误
tail -f server.log | grep ERROR

# 只看Dify相关
tail -f server.log | grep Dify

# 查看最近50行
tail -50 server.log
```

#### 2. 浏览器调试

**Chrome/Edge DevTools**：
1. 按 F12 打开开发者工具
2. Console面板 - 查看JavaScript错误
3. Network面板 - 查看API请求
   - 状态码200 = 成功
   - 状态码404 = 接口不存在
   - 状态码500 = 服务器错误
4. Application面板 - 查看LocalStorage

**查看详细请求信息**：
- 点击Network中的请求
- 查看Headers（请求头）
- 查看Payload（请求体）
- 查看Response（响应内容）

#### 3. 数据库调试

```bash
# 进入SQLite命令行
sqlite3 pet_food_selection.db

# 查看所有表
.tables

# 查看产品数量
SELECT species, COUNT(*) FROM products GROUP BY species;

# 查看前10个产品
SELECT id, product_name, brand, price FROM products LIMIT 10;

# 退出
.quit
```

#### 4. 常见问题排查

**问题1：端口被占用**
```bash
# 查找占用8000端口的进程
lsof -ti:8000

# 杀死进程
lsof -ti:8000 | xargs kill -9
```

**问题2：数据库错误**
```bash
# 重新初始化数据库
rm pet_food_selection.db
python3 sqlite_db_utils.py
```

**问题3：Dify API失败**
- 检查网络连接
- 验证环境变量 `DIFY_API_KEY`
- 查看server.log中的详细错误
- 确认API密钥未过期

**问题4：前端请求404**
- 检查 `static/app_fixed.js` 中的 `API_BASE` 配置
- 确认后端服务正在运行
- 查看Network面板的请求URL是否正确

---

### 四、发布到Render

#### 准备工作

**1. 确认所有测试通过**
```bash
bash 快速测试.sh
```

**2. 检查Git状态**
```bash
git status
git log --oneline -5
```

**3. 确保无敏感信息**
- API密钥已使用环境变量
- 无硬编码的密码或token
- .gitignore配置正确

#### 自动发布

```bash
bash 发布到Render.sh
```

脚本会自动：
1. ✅ 检查Git状态
2. 🧪 运行测试
3. 📂 验证关键文件
4. 🗄️ 检查数据库
5. 🚢 推送到GitHub

#### 手动发布

```bash
# 1. 提交修改
git add -A
git commit -m "准备发布到生产环境"

# 2. 推送到GitHub
git push origin main

# 3. 等待Render自动部署
```

#### Render后台配置

**首次部署需要配置**：

1. 登录 [Render Dashboard](https://dashboard.render.com)
2. 找到你的服务
3. 进入 Environment 选项卡
4. 添加以下环境变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `DIFY_API_KEY` | `app-H3Owfh8VRao6bUv6wFgRt7Kg` | Dify API密钥（必需） |
| `ENVIRONMENT` | `production` | 环境标识 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

5. 点击 "Save Changes" 保存
6. Render会自动重启服务

#### 部署验证

**等待部署完成**（约3-5分钟）

部署成功后，Render会分配一个URL，例如：
`https://your-app-name.onrender.com`

**验证步骤**：

```bash
# 设置你的部署URL
DEPLOY_URL="https://your-app-name.onrender.com"

# 1. 健康检查
curl "$DEPLOY_URL/api/health"

# 2. 产品API
curl "$DEPLOY_URL/api/products?species=cat&limit=3"

# 3. 浏览器访问
open "$DEPLOY_URL"  # macOS
# 或在浏览器中直接访问URL
```

**完整功能测试**：
按照"二、功能测试"章节的流程，在生产环境中再次测试。

---

### 五、监控与维护

#### 查看Render日志

1. 访问 Render Dashboard
2. 进入你的服务
3. 点击 "Logs" 选项卡
4. 实时查看部署和运行日志

#### 性能监控

**关键指标**：
- 首次加载时间 < 5秒
- API响应时间 < 3秒
- Dify分析时间 < 30秒

**测试方法**：
```bash
# 测试响应时间
time curl "$DEPLOY_URL/api/health"
```

#### 数据库维护

⚠️ **注意**：Render免费版使用短暂存储，SQLite数据库会在重启后丢失。

**当前解决方案**：
- 服务启动时自动初始化数据库
- 产品数据通过 `sqlite_db_utils.py` 重新生成

**长期方案**：
- 迁移到Render PostgreSQL（推荐）
- 使用Render持久化卷（付费功能）
- 定期备份数据库到云存储

---

### 六、回滚与应急

#### 快速回滚

如果生产环境出现问题：

```bash
# 1. 查看提交历史
git log --oneline -10

# 2. 回滚到上一个稳定版本
git reset --hard <stable_commit_hash>

# 3. 强制推送（谨慎！）
git push origin main --force
```

#### Render手动回滚

1. 访问 Render Dashboard
2. 进入 Deployments 选项卡
3. 找到上一个成功的部署
4. 点击 "..." > "Rollback to this version"

#### 紧急停服

如需紧急停止服务：
1. 在Render Dashboard中
2. 点击 "Manual Deploy" > "Clear build cache & deploy"
3. 或暂停服务：Settings > "Suspend Service"

---

## 🎓 最佳实践

### 开发流程

1. **本地开发**：在本地完成功能开发和调试
2. **本地测试**：运行 `bash 快速测试.sh` 验证
3. **提交代码**：`git add -A && git commit -m "..."`
4. **发布上线**：`bash 发布到Render.sh`
5. **部署验证**：在生产环境验证功能
6. **监控日志**：关注Render日志，确保稳定运行

### 测试策略

- ✅ 每次修改后必须本地测试
- ✅ 发布前运行自动测试脚本
- ✅ 生产环境发布后完整验证
- ✅ 保持测试覆盖关键功能

### 代码管理

- 🔒 敏感信息使用环境变量
- 📝 提交信息清晰明确
- 🏷️ 重要版本打tag
- 🌿 重大改动使用分支开发

---

## 📚 相关文档

- `BUG_FIX_REPORT.md` - BUG修复报告
- `发布前检查清单.md` - 详细检查清单
- `本地调试指南.md` - 调试技巧
- `README.md` - 项目总体说明

---

## 🆘 获取帮助

遇到问题？按以下顺序排查：

1. 📖 查看本文档相关章节
2. 📋 检查 `发布前检查清单.md`
3. 🐛 查看 `BUG_FIX_REPORT.md`
4. 📄 查看 `server.log` 日志
5. 🌐 搜索相关错误信息

---

**祝调试顺利，发布成功！🎉**
