# ✅ 发布前检查清单

## 📋 本地调试阶段

### 1. 服务启动检查
- [ ] 执行 `bash start_local.sh` 成功启动
- [ ] 访问 http://localhost:8000 页面正常显示
- [ ] 浏览器控制台无错误信息
- [ ] 查看 `server.log` 无ERROR日志

### 2. 核心功能测试
执行快速测试脚本：
```bash
bash 快速测试.sh
```

手动测试流程：
- [ ] **步骤1：填写宠物信息**
  - [ ] 选择物种（猫/狗）
  - [ ] 填写年龄、体重
  - [ ] 选择健康状态
  - [ ] 选择预算模式
  - [ ] 点击"下一步"正常跳转

- [ ] **步骤2：选择产品**
  - [ ] 产品列表正常加载
  - [ ] 产品图片、价格显示正确
  - [ ] 可以搜索和筛选产品
  - [ ] 可以选择/取消产品
  - [ ] 手动添加产品功能正常
  - [ ] 点击"开始分析"正常跳转

- [ ] **步骤3：查看分析结果**
  - [ ] 显示分析进度条
  - [ ] AI分析结果正常显示
  - [ ] 产品推荐列表正确
  - [ ] 推荐理由清晰明确
  - [ ] 产品详情弹窗功能正常

### 3. API接口测试
```bash
# 健康检查
curl http://localhost:8000/api/health
# 预期：{"status":"ok",...}

# 产品列表
curl 'http://localhost:8000/api/products?species=cat&limit=5'
# 预期：{"success":true,"products":[...]}
```

### 4. 数据库检查
```bash
# 验证数据库
python3 verify_database.py

# 检查产品数量
sqlite3 pet_food_selection.db "SELECT species, COUNT(*) FROM products GROUP BY species;"
```

预期结果：
- 猫粮产品 > 50 个
- 狗粮产品 > 30 个

### 5. 日志检查
```bash
tail -50 server.log
```

确认：
- [ ] 无 ERROR 级别日志
- [ ] Dify API调用成功（如有测试）
- [ ] 数据库连接正常
- [ ] 无异常堆栈信息

### 6. 浏览器兼容性
- [ ] Chrome/Edge - 功能正常
- [ ] Safari - 功能正常（注意localStorage警告）
- [ ] Firefox - 功能正常
- [ ] 移动端浏览器 - 响应式布局正常

---

## 🚀 准备发布阶段

### 7. 代码提交检查
```bash
# 查看未提交的修改
git status

# 查看最近提交
git log --oneline -5
```

确认：
- [ ] 所有修改已提交
- [ ] 提交信息清晰
- [ ] 无敏感信息（API密钥已用环境变量）
- [ ] .gitignore配置正确

### 8. Render后台配置

登录 [Render Dashboard](https://dashboard.render.com)

#### 环境变量设置
在后台添加以下环境变量：

| 变量名 | 值 | 必需 |
|--------|-----|------|
| `DIFY_API_KEY` | `app-H3Owfh8VRao6bUv6wFgRt7Kg` | ✅ |
| `ENVIRONMENT` | `production` | ✅ |
| `LOG_LEVEL` | `INFO` | 推荐 |
| `PYTHON_VERSION` | `3.11` | 可选 |

#### 构建配置检查
- [ ] Build Command: `pip install -r requirements.txt`
- [ ] Start Command: `python3 main_sqlite.py` 或 `uvicorn main_sqlite:app --host 0.0.0.0 --port 8000`
- [ ] Environment: `Python 3`
- [ ] Region: 选择就近区域

#### 数据库文件处理
⚠️ **重要**：Render使用短暂存储，SQLite数据库会在重启后丢失

建议方案：
1. **使用Render PostgreSQL**（推荐生产环境）
2. **使用持久化卷**（Render付费功能）
3. **启动时自动初始化数据库**（当前方案）

当前配置已在 `main_sqlite.py` 中实现自动初始化。

### 9. 部署测试

#### 推送代码
```bash
# 推送到GitHub（触发Render自动部署）
git push origin main
```

#### 监控部署
1. 访问 Render Dashboard
2. 查看部署日志
3. 等待构建完成（约3-5分钟）

#### 部署后验证
部署成功后，获取Render分配的URL，例如：
`https://your-app-name.onrender.com`

测试清单：
- [ ] 访问首页正常：`https://your-app-name.onrender.com`
- [ ] 健康检查通过：`https://your-app-name.onrender.com/api/health`
- [ ] 产品API正常：`https://your-app-name.onrender.com/api/products?species=cat&limit=5`
- [ ] 完整功能流程测试（与本地测试相同）

```bash
# 快速测试部署后的服务
DEPLOY_URL="https://your-app-name.onrender.com"

# 健康检查
curl "$DEPLOY_URL/api/health"

# 产品API
curl "$DEPLOY_URL/api/products?species=cat&limit=3"
```

### 10. 性能检查
- [ ] 首次访问加载时间 < 5秒
- [ ] API响应时间 < 3秒
- [ ] Dify分析完成时间 < 30秒
- [ ] 页面交互流畅，无卡顿

### 11. 错误监控
- [ ] 查看Render日志面板，无ERROR
- [ ] 测试错误场景（如输入异常数据）
- [ ] 验证错误提示友好明确

---

## 🎉 发布完成

### 12. 文档更新
- [ ] 更新 `README.md` 中的部署URL
- [ ] 记录生产环境配置
- [ ] 更新版本号（如适用）

### 13. 用户通知
- [ ] 分享生产环境URL
- [ ] 提供使用指南
- [ ] 说明功能特性

### 14. 备份与回滚准备
```bash
# 记录当前部署的commit
git log -1 --oneline

# 如需回滚
git revert <commit_hash>
git push origin main
```

---

## 🔧 常见问题

### Q1: Render部署失败
**检查项**：
- 查看Render部署日志
- 验证 `requirements.txt` 依赖
- 确认 `start.sh` 或启动命令正确

### Q2: 数据库为空
**原因**：Render重启后SQLite文件丢失
**解决**：
- 确保 `main_sqlite.py` 中有自动初始化逻辑
- 或迁移到PostgreSQL

### Q3: Dify API调用失败
**检查项**：
- Render环境变量 `DIFY_API_KEY` 是否设置
- 查看日志中的具体错误信息
- 验证API密钥是否有效

### Q4: 首次加载很慢
**原因**：Render免费版冷启动（15分钟无访问后休眠）
**解决**：
- 升级到付费版
- 使用健康检查脚本保活
- 告知用户首次访问需等待

---

## 📞 紧急回滚

如果生产环境出现严重问题：

```bash
# 1. 本地回滚到上一个稳定版本
git log --oneline -10
git reset --hard <stable_commit_hash>

# 2. 强制推送（谨慎操作！）
git push origin main --force

# 3. 或在Render后台手动回滚部署
```

---

**检查完成后，即可安心发布！🚀**
